<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">

<!--
`rise-google-sheet` is a web component that retrieves values from a Google Sheet specified by key and sheet name.

The `key` attribute is required which is to identify the Google Spreadsheet you want to target.
A spreadsheet's key can be found in the URL when viewing it in Google Docs
(e.g. docs.google.com/spreadsheets/d/< KEY >/edit#gid=0).

The `sheet` attribute is also required which is the name of the specific sheet within the Spreadsheet that you want
to retrieve values from. (eg. Sheet1)

The specified feed is periodically retrieved if the `refresh` attribute is set, although a minimum refresh
time of 1 minute is enforced.

#### Example Usage

    <rise-google-sheet key="abc123" sheet="Sheet1" refresh="30"></rise-google-sheet>

    <script>
      var sheet = document.querySelector('rise-google-sheet');

      // Respond to events it fires.
      sheet.addEventListener('rise-google-sheet-response', function(e) {
        if (e.detail && e.detail.results) {
          console.log(e.detail.results); // Array of sheet values
        }
      });

      sheet.go(); // Executes a request.
    </script>

#### Range

`rise-google-sheet` allows for fetching specific range of values from a worksheet by providing an attribute that expects
 A1 notation of the values to retrieve.

For example, to retrieve all values within cells A1 to B2 of the worksheet:

    <rise-google-sheet key="abc123" sheet="Sheet1" range="A1:B2"></rise-google-sheet>

#### Dimension

Optionally, the `dimension` attribute allows for specifying the major dimension that results should use.
For example, if the spreadsheet data is: A1=1,B1=2,A2=3,B2=4, then dimension="ROWS" will return [[1,2],[3,4]],
whereas dimension="COLUMNS" will return [[1,3],[2,4]].

#### Render

Optionally, the `render` attribute determines how values should be represented in the output. By default the
values will be calculated and formatted in the response according to the cell's formatting. For more detail on
the values that can be provided in this attribute and their impact, see [Google Sheets API - ValueRenderOption](https://developers.google.com/sheets/reference/rest/v4/ValueRenderOption)

@demo
-->
<dom-module id="rise-google-sheet">
  <template>
    <iron-ajax id="sheet"
               handle-as="json"
               on-response="_onSheetResponse"
               on-error="_onSheetError">
    </iron-ajax>
    <content></content>
  </template>
</dom-module>

<script>
  (function() {
    /* global Polymer */
    /* jshint newcap: false */

    "use strict";

    var API_BASE_URL = "https://sheets.googleapis.com/v4/spreadsheets/";

    var API_KEY = "AIzaSyBXxVK_IOV7LNQMuVVo_l7ZvN53ejN86zY";

    var LOCAL_STORAGE_BASE_NAME = "risesheet";

    function supportsLocalStorage() {
      try {
        return "localStorage" in window && window.localStorage !== null;
      } catch (e) {
        return false;
      }
    }

    Polymer({
      is: "rise-google-sheet",

      properties: {
        /**
         * The key of the spreadsheet. This can be found in the URL when viewing
         * the document in Google Docs (e.g. docs.google.com/spreadsheets/d/<KEY>).
         */
        key: {
          type: String,
          value: ""
        },

        /**
         * Name of sheet to target in a spreadsheet. For example, by default 'Sheet1' is the name of first sheet
         * in a new google spreadsheet
         */
        sheet: {
          type: String,
          value: ""
        },

        /**
         * The A1 notation of the values to retrieve.
         */
        range: {
          type: String,
          value: ""
        },

        /**
         * The major dimension that results should use. Options are 'ROWS' or 'COLUMNS'
         */
        dimension: {
          type: String,
          value: "ROWS"
        },

        /**
         * The number of minutes before another request will be made.
         */
        refresh: {
          type: Number,
          value: 0
        },

        /**
         * How values should be represented in the output. Options are 'FORMATTED_VALUE', 'UNFORMATTED_VALUE',
         * and 'FORMULA'
         */
        render: {
          type: String,
          value: "FORMATTED_VALUE"
        },

        /**
         * Returns the values from a spreadsheet.
         */
        results: {
          type: Array,
          value: function() { return []; },
          readOnly: true,
          notify: true
        }
      },

      _requestPending: false,

      // Element Behavior

      /**
       * Fired when a response is received.
       *
       * @param {Object} detail
       * @param {Object} detail.data The data returned by the Google Sheets API
       * @event rise-google-sheet-response
       */

      /**
       * Fired when an error is received.
       *
       * @event rise-google-sheet-error
       */

      _getLocalStorageKey: function () {
        return LOCAL_STORAGE_BASE_NAME + "_" + this.key;
      },

      _getCachedData: function () {
        if (supportsLocalStorage()) {
          // retrieve cached data and parse back
          return JSON.parse(localStorage.getItem(this._getLocalStorageKey()));
        }

        return null;
      },

      _setCachedData: function (data) {
        if (supportsLocalStorage()) {
          try {
            localStorage.setItem(this._getLocalStorageKey(), JSON.stringify(data));
          } catch(e) {
            console.warn(e.message);
          }
        }
      },

      _startTimer: function() {
        var refreshFn = this.go,
          self = this;

        this.refresh = parseInt(this.refresh, 10);

        if (!isNaN(this.refresh) && this.refresh !== 0) {
          this.debounce("refresh", function () {
            refreshFn.call(self);
          }, this.refresh * 60000);
        }
      },

      _prepareResponse: function (resp) {
        var response = {};

        /*
         Provide an empty array if values property missing in response object. This can occur if any range
         values (minColumn, maxColumn, minRow, maxRow) are out of scope of the data entered in worksheet
        */
        response.results = (resp.values) ? resp.values : [];

        return response;
      },

      _handleNoNetwork: function (resp) {
        var cachedData = this._getCachedData();

        if (cachedData) {
          this._setResults(cachedData.results);

          this.fire("rise-google-sheet-response", cachedData);
        }
        else {
          this.fire("rise-google-sheet-error", resp);
        }

        this._requestPending = false;
        this._startTimer();
      },

      _onSheetError: function(e, resp) {
        // in case there are other instances of rise-google-sheet
        e.stopPropagation();

        if (resp.request && resp.request.status === 0) {
          this._handleNoNetwork(resp);
        }
        else {
          // reset the value of cells
          this._setResults([]);

          // if cached data exists, remove it
          if (this._getCachedData()) {
            try {
              localStorage.removeItem(this._getLocalStorageKey());
            } catch (ex) {
              console.warn(ex.message);
            }
          }

          this.fire("rise-google-sheet-error", resp);

          this._requestPending = false;
          this._startTimer();
        }

      },

      _onSheetResponse: function(e, resp) {
        var responseData;

        // in case there are other instances of rise-google-sheet
        e.stopPropagation();

        if (resp && resp.response) {
          responseData = this._prepareResponse(resp.response);

          // cache the data if possible
          this._setCachedData(responseData);

          // use setter method to apply results value because this property is read only
          this._setResults(responseData.results);

          this.fire("rise-google-sheet-response", responseData);
        }

        this._requestPending = false;
        this._startTimer();

      },

      _getParams: function() {
        var params = {};

        // required to obtain public data
        params.key = API_KEY;

        params.majorDimension = this.dimension;

        params.valueRenderOption = this.render;

        return params;
      },

      _getRange: function() {
        return (this.range === "") ? "" : "!" + this.range;
      },

      _getUrl: function() {
        return API_BASE_URL + this.key + "/values/" + this.sheet + this._getRange();
      },

      /**
       * Performs a request to obtain the Google Sheet data
       *
       */
      go: function() {
        // key is required, don't make request if missing 'key' or if a previous request is pending
        if (this.key === "" || this.sheet === "" || this._requestPending) {
          return;
        }

        // set flag to prevent further requests in case go() function is called before prior request responds
        this._requestPending = true;

        // apply url and params to the iron-ajax instance
        this.$.sheet.url = this._getUrl();
        this.$.sheet.params = this._getParams();

        this.$.sheet.generateRequest();
      }

    });
  })();
</script>
